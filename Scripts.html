<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>
    // constants
    var REFRESH_INTERVAL = 1000; // update selected text inspector every 1 second
    var TIMEOUT = 20000; // timout of 20s for fetching recommendations

    // global variables
    var lastSelectedText;
    var lastSearchedText;
    var searchResultList;

    /**
     * On document load.
     */
    $(function() {
        // init search bar
        $("#eexcess-search").keyup(function (e) {
            if (e.keyCode == 13) { // Enter keycode
                $('#btn-search').click();
            }
        });

        $('#btn-search').click(getRecommendationsFromInput);

        // init search results list
        searchResultList = new SearchResultList();

        $('#settings-button').click(openSettings);

        inspectSelectedText();
    });

    function openSettings() {
        google.script.run.openSettingsDialog();
    }

    /**
     * Runs a server-side function to get the recommendations for the user-entered text and update
     * the sidebar UI with the results from the privacy proxy.
     */
    function getRecommendationsFromInput() {
        var keyword = $("#eexcess-search").val();
        if(keyword == "") {
            searchResultList.showError('<?!= msg('SEARCHBAR_EMPTY') ?>');
        } else {
            this.disabled = true;
            fetchAndDisplayRecommendations(keyword, this);
        }
    }

    /**
     * Checks if the current selected text in the document has changed. If it changed automatically a search request
     * will be submitted to the recommender.
     */
    function inspectSelectedText() {
        google.script.run
                .withSuccessHandler(
                function(selectedText) {
                    if (selectedText.length > 0 && !arraysEqual(selectedText, lastSelectedText)) {
                        lastSelectedText = selectedText;
                        $("#eexcess-search").val(selectedText);
                        $('#btn-search').click();
                    }
                })
                .withFailureHandler(
                function() {
                    // ignore errors
                })
                .getSelectedText();

        window.setTimeout(inspectSelectedText, REFRESH_INTERVAL);
    }

    /**
     * Runs a server-side function to fetch the recommendations for the given text and updates the sidebar UI with the
     * results from the privacy proxy  or displays and error message in the sidebar.
     *
     * @param {String} or {Array<String>} text  text for which the recommendations should be fetched
     * @param button    disabled button which triggered the action or undefined if action was not triggered by a button
     */
    function fetchAndDisplayRecommendations(text, button){
        searchResultList.showAjaxLoader();

        var responded = false;
        var timeout = false;
        lastSearchedText = text;

        setTimeout(function() {
            if(!responded) {
                timeout = true;

                if (lastSearchedText == text)
                    searchResultList.showError("<?!= msg('TIMEOUT') ?>");

                if (button)
                    button.disabled = false;
            }
        }, TIMEOUT);

        google.script.run
                .withSuccessHandler(
                function(recommendations, button) {
                    if(!timeout && lastSearchedText == text){
                        responded = true;
                        searchResultList.showResults(recommendations);

                        if (button)
                            button.disabled = false;
                    }
                })
                .withFailureHandler(
                function(errorMsg, button) {
                    if(!timeout && lastSearchedText == text) {
                        responded = true;
                        searchResultList.showError(errorMsg);

                        if (button)
                            button.disabled = false;
                    }
                })
                .withUserObject(button)
                .fetchRecommendations([text]);
    }

    /**
     * Compares two 1-dimensional arrays by their content.
     *
     * @param a array 1
     * @param b array 2
     */
    function arraysEqual(a, b) {
        if (a === b)
            return true;

        if (a == null || b == null)
            return false;

        if (a.length != b.length)
            return false;

        for (var i = 0; i < a.length; ++i) {
            if (a[i] !== b[i])
                return false;
        }

        return true;
    }
</script>