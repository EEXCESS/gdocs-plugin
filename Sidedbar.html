<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
<!-- The CSS package above applies Google styling to buttons and other elements. -->

<style>
.branding-below {
  bottom: 94px;
}
.branding-text {
  left: 7px;
  position: relative;
  top: 3px;
}
.logo {
  vertical-align: middle;
}
.height-75 {
  height: 75%;
}
#ajax-loader-container {
  text-align: center;
  margin-top: 50px;
}

#eexcess-search {
  width: 150px;
  height: 24px;
  border: 1px solid gray;
  padding-left: 5px;
}

#search-container {
  float: left;
  margin-bottom: 10px;
}

#eexcess-recommendations {
  clear: both;
}

.result-details {
  margin: 0px;
}

.block {
  border-top: 1px solid gray;
}

#get-recommendations {
  margin-top: 5px;
}

/* ResultList styling */
#eexcess-recommendations-list {
  padding-left: 2px;
}

#eexcess-recommendations-list li {
  min-height: 70px;
  border-bottom: 1px solid #ccc;
  display: table;
  border-collapse: collapse;
  width: 100%;
}

#eexcess-recommendations-list li:hover {
 background-color: rgba(29,144,78,0.2);
}

#eexcess-recommendations-list a:hover {
  text-decoration: none; 
}

.inner {
  display: table-row;
  overflow: hidden;
}

.li-img {
  display: table-cell;
  vertical-align: middle;
  width: 20%;
  padding-right: 1em;
}

.li-img img {
  display: block;
  width: 100%;
  height: auto;
}

.li-text {
  display: table-cell;
  vertical-align: middle;
  width: 70%;
  padding-right: 1em;
}

.li-head {
  margin: 0;
  font-size: 12px;
}
.li-summary {
  margin: 0 0 4px 0;
  display: block;
  color: #999;
}

.li-provider {
  margin: 0px;
  font-size: 10px;
}

</style>

<div class="sidebar content height-75">
  <div id="search-container">
      <input id="eexcess-search" placeholder="Search" aria-label="Search" />
      <button class="blue" id="btn-search">Search</button>
  </div>
  <div id="eexcess-recommendations">
    <div class="block form-group">
      <ul id="eexcess-recommendations-list">
      
      </ul>
    </div>
  </div>
</div>

<div class="sidebar branding-below">
  <div class="block" id="button-bar">
      <button class="blue" id="get-recommendations">Get Recommendations</button>
    </div>
</div>

<div class="sidebar bottom">
  <img alt="Add-on logo" class="logo" width="222" height="70" src="http://eexcess.eu/wp-content/uploads/2013/04/eexcess_Logo_neu1.jpg">
  <span classâ€ ="gray branding-text"> Recommendations by EEXCESS</span>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">
</script>
<script>
  /**
   * On document load, assign click handle to the "get-recommendations" button 
   */ 
  $(function() {
    $('#get-recommendations').click(getRecommendations);
    
    $("#eexcess-search").keyup(function (e) {
      if (e.keyCode == 13) {
        $('#btn-search').click();
      }
    });
    
    $('#btn-search').click(getRecommendationsFromInput);
  });
  
  /**
   * Runs a server-side function to get the recommendations for the user-entered text and update
   * the sidebar UI with the results from the privacy proxy.
   */
  function getRecommendationsFromInput() {
      removeError();
      var keyword = $("#eexcess-search").val();
      if(keyword == "") {
        showError("Please enter some text.", $('#button-bar'));  
      } else {
        this.disabled = true;
        // Clear previously loaded recommendations
        $("#eexcess-recommendations-list").empty();
        // Remove error messages
        removeError();
        // Insert Ajax loader icon
        showAjaxLoader();
        var responded = false;
        var timeout = false;
        setTimeout(function() {
          if(!responded) {
            timeout = true;
            removeAjaxLoader();
            showError("The server timed out waiting for the request.", $('#button-bar'));
            $('#btn-search').removeAttr("disabled");
          }
        }, 20000);
       
        google.script.run
         .withSuccessHandler(
          function(recommendations, element) { 
            if(!timeout) {
              responded = true;
              removeAjaxLoader();
              // Display Results
              showResultList(recommendations);
              element.disabled = false;
            }
          })
        .withFailureHandler(
          function(msg, element) {
            if(!timeout) {
              removeAjaxLoader();
              showError(msg, $('#button-bar'));
              element.disabled = false;
            }
          })
        .withUserObject(this)
        .getRecommandationsFromInput(keyword);

      }
  }
  
  /**
   * Runs a server-side function to get the recommendations for the user-selected text and update
   * the sidebar UI with the results from the privacy proxy.
   */
  function getRecommendations() {
    $('#eexcess-search').val('');
    this.disabled = true;
    // Clear previously loaded recommendations
    $("#eexcess-recommendations-list").empty();
    // Remove error messages
    removeError();
    // Insert Ajax loader icon
    showAjaxLoader();    
    var responded = false;
    var timeout = false;
    setTimeout(function() {
      if(!responded) {
        timeout = true;
        removeAjaxLoader();
        showError("The server timed out waiting for the request.", $('#button-bar'));
        $('#get-recommendations').removeAttr("disabled");
      }
    }, 20000);
    google.script.run
        .withSuccessHandler(
          function(recommendations, element) { 
            if(!timeout) {
              responded = true;
              removeAjaxLoader();
              // Display Results
              showResultList(recommendations);
              element.disabled = false;
            }
          })
        .withFailureHandler(
          function(msg, element) {
            if(!timeout) {
              removeAjaxLoader();
              showError(msg, $('#button-bar'));
              element.disabled = false;
            }
          })
        .withUserObject(this)
        .getRecommendations();
  }
  
  /**
   * Inserts the result list
   *
   * @param recommendations The results
   */
  function showResultList(recommendations) {
    var container = $("#eexcess-recommendations-list");
    var titleLength = 30;
    var descriptionLength = 80;
    // Parsing the JSON string 
    var o = JSON.parse(recommendations);
    if(o.totalResults > 0) {
      // iterate the results and append the list elements
      $.each(o.result, function() {
        var title = this.title;
        if(this.title.length > titleLength) {
          title = jQuery.trim(title).substring(0, titleLength).split(" ").slice(0, -1).join(" ") + "...";
        } 
        var previewImage = "http://dummyimage.com/60x60/999/fff.png&text=+";
        
        if(this.previewImage) {
          previewImage = this.previewImage;
        }
        
        var description = "No description available.";
        
        if(this.description) {
          description = this.description;
        }
        
        var titleDescription = description;
        if(description.length > descriptionLength) {
          description = jQuery.trim(description).substring(0, descriptionLength).split(" ").slice(0, -1).join(" ") + "...";
        }
        
        var template = 
          '<li>' +
		    '<a href="' + this.uri + '" target="_blank" class="inner">' +
			  '<div class="li-img">' +		
			    '<img src="' + previewImage + '" alt="Image Alt Text" />' +			
			  '</div>' +
			  '<div class="li-text">' +
			    '<h4 class="li-head" title="' + this.title + '">' + title + '</h4>' +
                '<p class="li-provider">Provider: ' + this.facets.provider + '</p>' +
				'<p class="li-summary" title="' + titleDescription + '">' + description + '</p>' +		
			  '</div>' +
			'</a>' +
		  '</li>';
        container.append(template);
      })
    } else {
      showError("No results found", $('#button-bar'));  
    }
  }
  
  /**
   * Inserts a div that contains an error message after a given element.
   *
   * @param msg The error message to display.
   * @param element The element after which to display the error.
   */
  function showError(msg, element) {
    removeError();
    var div = $('<div id="error" class="error">' + msg + '</div>');
    $(element).after(div);
  }
  
  /**
   * Removes previously added error messages.
   */
  function removeError() {
    $("#error").remove();
  }
  
  /**
   * Removes the ajax loader icon (spinner) from the DOM.
   */
  function removeAjaxLoader() {
    $('#ajax-loader-container').remove();
  }
  
  /**
   * Inserts the ajax loader icon.
   */
  function showAjaxLoader() {
   $('<div id="ajax-loader-container"><img src="http://mics.fim.uni-passau.de/wp-content/uploads/2014/10/ajax-loader.gif" width="16px" height="16px" alt="ajax loader"/></div>').insertAfter("#eexcess-recommendations-list");
  }
</script>
